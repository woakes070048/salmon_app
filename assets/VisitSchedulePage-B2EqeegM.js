import{g as Z,a as ee,r as n,u as U,j as e,s as H,c as O,b as E,T as d,d as B,e as te,h as se,B as p,C as D,I as oe,H as ne,i as ae,k as z}from"./index-BStpc4DZ.js";import{A as F}from"./Alert-NFvkCvVw.js";import{C as re}from"./Container-XVaRKa_4.js";import{B as f}from"./Button-B5v1ba7m.js";import{C as ie,a as ce,b as le}from"./CardHeader-BFeaUQlz.js";import{D as de,g as ue,a as he,b as ge,c as xe,C as me}from"./DialogContent-CuH6RQez.js";function pe(i){return Z("MuiCardActions",i)}ee("MuiCardActions",["root","spacing"]);const Ce=i=>{const{classes:a,disableSpacing:c}=i;return E({root:["root",!c&&"spacing"]},pe,a)},fe=H("div",{name:"MuiCardActions",slot:"Root",overridesResolver:(i,a)=>{const{ownerState:c}=i;return[a.root,!c.disableSpacing&&a.spacing]}})({display:"flex",alignItems:"center",padding:8,variants:[{props:{disableSpacing:!1},style:{"& > :not(style) ~ :not(style)":{marginLeft:8}}}]}),je=n.forwardRef(function(a,c){const u=U({props:a,name:"MuiCardActions"}),{disableSpacing:j=!1,className:h,...C}=u,g={...u,disableSpacing:j},y=Ce(g);return e.jsx(fe,{className:O(y.root,h),ownerState:g,ref:c,...C})}),ye=i=>{const{classes:a}=i;return E({root:["root"]},ue,a)},ke=H(d,{name:"MuiDialogTitle",slot:"Root"})({padding:"16px 24px",flex:"0 0 auto"}),ve=n.forwardRef(function(a,c){const u=U({props:a,name:"MuiDialogTitle"}),{className:j,id:h,...C}=u,g=u,y=ye(g),{titleId:k=h}=n.useContext(de);return e.jsx(ke,{component:"h2",className:O(y.root,j),ownerState:g,ref:c,variant:"h6",id:h??k,...C})}),be=B(e.jsx("path",{d:"m21.9 8.89-1.05-4.37c-.22-.9-1-1.52-1.91-1.52H5.05c-.9 0-1.69.63-1.9 1.52L2.1 8.89c-.24 1.02-.02 2.06.62 2.88.08.11.19.19.28.29V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-6.94c.09-.09.2-.18.28-.28.64-.82.87-1.87.62-2.89m-2.99-3.9 1.05 4.37c.1.42.01.84-.25 1.17-.14.18-.44.47-.94.47-.61 0-1.14-.49-1.21-1.14L16.98 5zM13 5h1.96l.54 4.52c.05.39-.07.78-.33 1.07-.22.26-.54.41-.95.41-.67 0-1.22-.59-1.22-1.31zM8.49 9.52 9.04 5H11v4.69c0 .72-.55 1.31-1.29 1.31-.34 0-.65-.15-.89-.41-.25-.29-.37-.68-.33-1.07m-4.45-.16L5.05 5h1.97l-.58 4.86c-.08.65-.6 1.14-1.21 1.14-.49 0-.8-.29-.93-.47-.27-.32-.36-.75-.26-1.17M5 19v-6.03c.08.01.15.03.23.03.87 0 1.66-.36 2.24-.95.6.6 1.4.95 2.31.95.87 0 1.65-.36 2.23-.93.59.57 1.39.93 2.29.93.84 0 1.64-.35 2.24-.95.58.59 1.37.95 2.24.95.08 0 .15-.02.23-.03V19z"})),we=B(e.jsx("path",{d:"M14 10H3v2h11zm0-4H3v2h11zm4 8v-4h-2v4h-4v2h4v4h2v-4h4v-2zM3 16h7v-2H3z"})),Te=()=>{var M,_;const{employeeId:i}=te(),a=se(),[c,u]=n.useState([]),[j,h]=n.useState(!0),[C,g]=n.useState(null),[y,k]=n.useState(!1),[v,V]=n.useState(null),r=n.useRef(null),x=n.useRef(null),[b,I]=n.useState(null),[L,N]=n.useState(null),[o,A]=n.useState(null),[w,R]=n.useState(!1),[T,m]=n.useState(null);n.useEffect(()=>{(async()=>{if(!i){g("Employee ID not available."),h(!1);return}try{h(!0);const s=await ae();u(s)}catch(s){g(s.message||"Failed to fetch data.")}finally{h(!1)}})()},[i]);const W=t=>{let s="default",l=t;switch(t){case"Checked In":s="warning";break;case"Completed":s="success";break;case"Canceled":s="error";break;case"Planned":case"Draft":s="default",l=t;break}return e.jsx(me,{label:l,color:s,size:"small",sx:{fontWeight:"bold"}})},$=async t=>{try{h(!0);const s=await z(t,"Checked In");console.log("handleCheckIn - success from API:",s),s?(console.log("handleCheckIn - entering if block"),u(l=>l.map(P=>P.name===t?{...P,status:"Checked In",checkin_time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})}:P))):(console.log("handleCheckIn - entering else block"),g("Failed to check-in."))}catch(s){console.log("handleCheckIn - entering catch block:",s),g(s.message||"An unexpected error occurred during check-in.")}finally{h(!1)}},G=t=>{V(t),k(!0),I(null),A(null),m(null),J(),Q()},S=()=>{k(!1),K()},J=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:!0});r.current&&(r.current.srcObject=t,r.current.play())}catch(t){console.error("Error accessing camera: ",t),m("Failed to access camera. Please grant permissions.")}},K=()=>{r.current&&r.current.srcObject&&(r.current.srcObject.getTracks().forEach(l=>l.stop()),r.current.srcObject=null)},q=()=>{if(r.current&&x.current){const t=x.current.getContext("2d");t&&(x.current.width=r.current.videoWidth,x.current.height=r.current.videoHeight,t.drawImage(r.current,0,0,x.current.width,x.current.height),x.current.toBlob(s=>{if(s){const l=new File([s],`checkout_photo_${Date.now()}.png`,{type:"image/png"});N(l),I(URL.createObjectURL(s))}else m("Failed to capture photo as Blob.")},"image/png",.8))}},Q=()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{A({latitude:t.coords.latitude,longitude:t.coords.longitude})},t=>{console.error("Error getting geolocation: ",t),m("Failed to get location. Please grant permissions.")}):m("Geolocation is not supported by your browser.")},X=async()=>{if(v){R(!0),m(null);try{await z(v,"Completed",{latitude:o==null?void 0:o.latitude,longitude:o==null?void 0:o.longitude,photo_file:L})?(u(s=>s.map(l=>l.name===v?{...l,status:"Completed",checkout_time:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),latitude:o==null?void 0:o.latitude,longitude:o==null?void 0:o.longitude,photo_url:b}:l)),S()):m("Failed to complete checkout.")}catch(t){m(t.message||"An unexpected error occurred during checkout.")}finally{R(!1)}}},Y=t=>{a(`/history/${t}`)};return j?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(D,{})}):C?e.jsx(p,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:e.jsx(F,{severity:"error",children:C})}):e.jsxs(e.Fragment,{children:[e.jsx(re,{sx:{mt:0,alignSelf:"flex-start"},children:c.length===0?e.jsxs(p,{sx:{textAlign:"top",mt:1,p:3,border:"2px dashed",borderColor:"grey.300",borderRadius:2},children:[e.jsx(we,{sx:{fontSize:60,color:"grey.400"}}),e.jsx(d,{variant:"h6",sx:{mt:2,color:"text.secondary",fontWeight:"bold"},children:"Tidak Ada Rencana Kunjungan"}),e.jsx(d,{variant:"body1",sx:{mt:1,color:"text.secondary"},children:"Jadwal untuk hari ini masih kosong."}),e.jsx(f,{variant:"contained",sx:{mt:3},onClick:()=>a("/input-visit"),children:"Buat Kunjungan Baru"})]}):e.jsx(p,{sx:{width:"100%"},children:c.map(t=>e.jsxs(ie,{sx:{mb:3,border:"1px solid #e0e0e0",boxShadow:"4px 4px 8px rgba(0,0,0,0.1)"},children:[e.jsx(ce,{avatar:e.jsx(be,{color:"primary",fontSize:"large"}),action:W(t.status),title:t.store_name,titleTypographyProps:{fontWeight:"bold",variant:"h6"},sx:{backgroundColor:"grey.200","& .MuiCardHeader-action":{alignSelf:"center"}}}),e.jsxs(le,{sx:{display:"flex",flexDirection:"column",gap:1.5,pt:1},children:[e.jsxs(d,{variant:"body2",children:[e.jsx("strong",{children:"Alamat:"}),e.jsx("br",{}),t.address]}),e.jsxs(d,{variant:"body2",children:[e.jsx("strong",{children:"Jadwal:"})," ",t.planned_visit_time||"-"]}),e.jsxs(d,{variant:"body2",children:[e.jsx("strong",{children:"Check In:"})," ",t.checkin_time||"-"]}),e.jsxs(d,{variant:"body2",children:[e.jsx("strong",{children:"Check Out:"})," ",t.checkout_time||"-"]}),t.notes&&e.jsxs(d,{variant:"body2",children:[e.jsx("strong",{children:"Catatan:"})," ",t.notes]})]}),e.jsxs(je,{sx:{justifyContent:"space-between",px:2,py:1.5,backgroundColor:"grey.50"},children:[e.jsx(oe,{"aria-label":"view order history",onClick:()=>Y(t.store_name),children:e.jsx(ne,{})}),e.jsxs(p,{sx:{display:"flex",gap:1},children:[(t.status==="Draft"||t.status==="Planned")&&e.jsx(f,{variant:"contained",onClick:()=>$(t.name),children:"Check-in"}),t.status==="Checked In"&&e.jsx(f,{variant:"contained",color:"secondary",onClick:()=>G(t.name),children:"Checkout"})]})]})]},t.name))})}),e.jsxs(he,{open:y,onClose:S,children:[e.jsxs(ve,{children:["Complete Checkout for ",(M=c.find(t=>t.name===v))==null?void 0:M.store_name]}),e.jsxs(ge,{children:[T&&e.jsx(F,{severity:"error",sx:{mb:2},children:T}),e.jsxs(p,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(d,{variant:"subtitle1",children:"Take Photo:"}),e.jsx("video",{ref:r,style:{width:"100%",maxWidth:"320px",border:"1px solid #ccc"},autoPlay:!0,playsInline:!0}),e.jsx(f,{variant:"outlined",onClick:q,disabled:!((_=r.current)!=null&&_.srcObject),children:"Capture Photo"}),b&&e.jsxs(p,{children:[e.jsx(d,{variant:"subtitle2",children:"Preview:"}),e.jsx("img",{src:b,alt:"Captured",style:{width:"100%",maxWidth:"320px",border:"1px solid #ccc"}})]}),e.jsx("canvas",{ref:x,style:{display:"none"}}),e.jsx(d,{variant:"subtitle1",children:"Current Location:"}),o?e.jsxs(d,{children:["Lat: ",o.latitude.toFixed(6),", Lng: ",o.longitude.toFixed(6)]}):e.jsx(D,{size:20})]})]}),e.jsxs(xe,{children:[e.jsx(f,{onClick:S,disabled:w,children:"Cancel"}),e.jsx(f,{onClick:X,disabled:w||!b||!o,variant:"contained",children:w?e.jsx(D,{size:24,color:"inherit"}):"Complete Checkout"})]})]})]})};export{Te as default};
